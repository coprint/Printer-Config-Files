## DO NOT EDIT THIS FILE, IT IS A TEMPLATE. THAT YOU NEED TO COPY
# Prusa MK3s Klipper Config

# The first thing you'll need to do is go through this file and comment out / uncomment
# the files and/or settings you need.

# You'll be able to print just fine with this config as it is, but it is recommended
# that you follow these steps to properly calibrate your printer:

# 0) Sanity check and PID Tuning: https://www.klipper3d.org/Config_checks.html
# 1) Pressure Advance: https://www.klipper3d.org/Pressure_Advance.html
# 2) Skew Correction: https://www.klipper3d.org/skew_correction.html
# 3) Resonance Compensation: https://www.klipper3d.org/Resonance_Compensation.html

# Read more about klipper here: https://www.klipper3d.org/Overview.html

### UI
[include chroma_head.cfg]
[include bed_mesh.cfg]
#[include mainsail.cfg]
[include driver.cfg]
#[include kcm.cfg]
[include cp_macro.cfg]
#[include prusa_macro.cfg]

[mcu]
serial:/dev/serial/by-path/platform-xhci-hcd.3.auto-usb-0:1.2:1.0 # If you are using internal RPI serial port
# serial: /dev/ttyACM0 # If you are using RPI via USB connection to printer
restart_method: command

[printer]
kinematics: cartesian
max_velocity: 240
max_accel: 4000
minimum_cruise_ratio: 0.5
max_z_velocity: 15
max_z_accel: 200
square_corner_velocity: 5


[stepper_x]
step_pin: PC0
dir_pin: !PL0
enable_pin: !PA7
microsteps: 16
rotation_distance: 32
endstop_pin: tmc2130_stepper_x:virtual_endstop
position_endstop: -5
position_min: -5
position_max: 229
homing_speed: 50
homing_retract_dist: 0

[stepper_y]
step_pin: PC1
dir_pin: PL1
enable_pin: !PA6
microsteps: 16
rotation_distance: 32
endstop_pin: tmc2130_stepper_y:virtual_endstop
position_endstop: -4
position_max: 212.5
position_min: -4
homing_speed: 50
homing_retract_dist: 0

[stepper_z]
step_pin: PC2
dir_pin: !PL2
enable_pin: !PA5
microsteps: 16
rotation_distance: 8
endstop_pin: probe:z_virtual_endstop
position_max: 215
position_min: -2
homing_speed: 8


[tmc2130 stepper_x]
cs_pin: PG0
interpolate: True
stealthchop_threshold: 0
run_current: .281738
hold_current: .281738
sense_resistor: 0.220
diag1_pin: !PK2
driver_IHOLDDELAY: 8
driver_TPOWERDOWN: 0
driver_TBL: 2
driver_TOFF: 3
driver_HEND: 1
driver_HSTRT: 5
driver_PWM_FREQ: 2
driver_PWM_GRAD: 2
driver_PWM_AMPL: 230
driver_PWM_AUTOSCALE: True
driver_SGT: 3

[tmc2130 stepper_y]
cs_pin: PG2
interpolate: True
stealthchop_threshold: 0
run_current: .281738
hold_current: .281738
sense_resistor: 0.220
diag1_pin: !PK7
driver_IHOLDDELAY: 8
driver_TPOWERDOWN: 0
driver_TBL: 2
driver_TOFF: 3
driver_HEND: 1
driver_HSTRT: 5
driver_PWM_FREQ: 2
driver_PWM_GRAD: 2
driver_PWM_AMPL: 230
driver_PWM_AUTOSCALE: True
driver_SGT: 3

[tmc2130 stepper_z]
cs_pin: PK5
run_current: .53033
hold_current: .53033
sense_resistor: 0.220
diag1_pin: !PK6
interpolate: True
driver_IHOLDDELAY: 8
driver_TPOWERDOWN: 0
driver_TBL: 2
driver_TOFF: 3
driver_HEND: 1
driver_HSTRT: 5
driver_PWM_FREQ: 2
driver_PWM_GRAD: 4
driver_PWM_AMPL: 200
driver_PWM_AUTOSCALE: True
driver_SGT: 4


[heater_bed]
heater_pin: PG5
sensor_type: EPCOS 100K B57560G104F
sensor_pin: PF2
control: pid
pid_Kp: 52.924
pid_Ki: 0.661
pid_Kd: 1059.794
min_temp: 0
max_temp: 125


[display]
lcd_type: hd44780
rs_pin: PD5
e_pin: PF7
d4_pin: PF5
d5_pin: PG4
d6_pin: PH7
d7_pin: PG3
encoder_pins: ^PJ1,^PJ2
click_pin: ^!PH6

# [output_pin BEEPER_pin]
# pin: display_beeper_pin
# pwm: True
# value: 0
# shutdown_value:0
# cycle_time: 0.001
# scale: 1000

[menu __filament __load]
type: command
name: Load Filament
gcode:
    LOAD_FILAMENT

[menu __filament __unload]
type: command
name: Unload Filament
gcode:
    UNLOAD_FILAMENT


# ### CONTROL BOARD
# [include klipper-prusa-mk3s/mk3s/einsy-rambo.cfg]

# ### BASE SETUP
# [include klipper-prusa-mk3s/mk3s/display.cfg]
# [include klipper-prusa-mk3s/mk3s/steppers.cfg]
# [include klipper-prusa-mk3s/mk3s/tmc2130.cfg]

[safe_z_home]
home_xy_position: 113,87
z_hop: 10
z_hop_speed: 5

# ### EXTRUSION

# # Extruder
# [include klipper-prusa-mk3s/extruders/prusa.cfg]
# # [include klipper-prusa-mk3s/extruders/bmg.cfg]

# # Hotend
# [include klipper-prusa-mk3s/hotends/v6.cfg]
# # [include klipper-prusa-mk3s/hotends/dragon-standard-flow.cfg]
# # [include klipper-prusa-mk3s/hotends/rapido.cfg]


## copy this from your current setting on Prusa, but make it absolute (removing -)
# [probe]
# z_offset = 0.685

## For faster printing enable
# [printer]
# max_accel: 2000
# max_accel_to_decel: 2000
# max_z_velocity: 20
# max_z_accel: 300

## For stealth mode enable

# [tmc2130 stepper_x]
# interpolate: True
# stealthchop_threshold: 80
# [tmc2130 stepper_y]
# interpolate: True
# stealthchop_threshold: 80
# [tmc2130 stepper_z]
# interpolate: True
# stealthchop_threshold: 80

## Custom bed mest probes
## Prusa has 3x3 or 7x7, you can do any variation you want
# [bed_mesh]
# probe_count: 4,4

# Linear correction
# Check `extruders/linear-correction` for more informations.
#[include klipper-prusa-mk3s/extruders/linear-correction/linear-correction-0.cfg] # Default Prusa linear correction optimized for LDO motors

### MACROS
# [include klipper-prusa-mk3s/macros.cfg]

# FIRST RUN: 
# Execute these sequentially in the console, let PID tuning finish before saving
# PID_CALIBRATE HEATER=extruder TARGET=170
# SAVE_CONFIG
# PID_CALIBRATE HEATER=heater_bed TARGET=60
# SAVE_CONFIG

### The end, on the end the printer will store it's tuning data, so do not edit it.

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [probe]
#*# z_offset = 5.970
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	  0.095000, 0.182500, 0.160000, 0.065000, -0.240000, -0.065000, -0.132500, -0.185000, -0.180000
#*# 	  0.075000, 0.207500, 0.187500, 0.072500, -0.045000, 0.007500, -0.052500, -0.025000, -0.172500
#*# 	  0.047500, 0.205000, 0.185000, 0.035000, -0.070000, 0.017500, -0.020000, 0.040000, -0.105000
#*# 	  0.000000, 0.150000, 0.132500, 0.045000, 0.000000, 0.030000, 0.000000, 0.097500, -0.030000
#*# 	  -0.120000, 0.007500, 0.077500, 0.092500, 0.035000, 0.035000, -0.087500, 0.052500, 0.045000
#*# 	  -0.065000, 0.112500, 0.180000, 0.120000, 0.087500, 0.140000, 0.115000, 0.247500, 0.152500
#*# 	  -0.047500, 0.140000, 0.190000, 0.135000, 0.097500, 0.222500, 0.220000, 0.357500, 0.282500
#*# 	  -0.040000, 0.147500, 0.207500, 0.197500, 0.227500, 0.312500, 0.295000, 0.440000, 0.400000
#*# 	  0.142500, 0.312500, 0.445000, 0.265000, 0.435000, 0.615000, 0.557500, 0.680000, 0.765000
#*# x_count = 9
#*# y_count = 9
#*# mesh_x_pps = 2
#*# mesh_y_pps = 2
#*# algo = bicubic
#*# tension = 0.2
#*# min_x = 38.0
#*# max_x = 230.0
#*# min_y = 0.0
#*# max_y = 210.0
